{% load static %}
<!doctype html>
<html lang="pl">
<head>
  <meta charset="utf-8">
  <title>Panel – {{ group }}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root { --b:#e5e7eb; --t:#111827; --mut:#6b7280; }

    * { box-sizing: border-box; }

    body { font-family: system-ui, Segoe UI, Roboto, Arial, sans-serif; color:var(--t); margin:16px; }

    /* --- HERO (nagłówek) --- */
    .hero{
      border:0.5px solid var(--b);
      border-radius:18px;
      padding: clamp(20px, 5vw, 48px);
      background:
        radial-gradient(90% 90% at 0% 0%, #e9f2ff 0%, transparent 60%),
        radial-gradient(90% 90% at 100% 0%, #e9ffef 0%, transparent 60%),
        #fff;
      margin-bottom: 18px;
    }
    .hero h1{ font-size: clamp(28px, 5vw, 44px); line-height:1.1; margin:10px 0 4px; }
    .hero p{ color:var(--mut); margin:0; }
    .hero .panel-title { font-size: clamp(22px, 4vw, 32px); font-weight:600; margin:10px 0 4px; }

    /* --- KARTA --- */
    .card{
      border:1px solid var(--b);
      border-radius:14px;
      background:#fff;
      padding:14px;
      box-shadow:0 6px 18px rgba(0,0,0,.04);
      margin-bottom:14px;
    }

    .bar { display:flex; flex-wrap:wrap; gap:8px; align-items:center; margin:0 0 8px; }
    h2 { font-size:16px; margin:0 0 10px; }

    input[type=text], select { padding:6px 8px; border:1px solid var(--b); border-radius:6px; }
    button, .btn {
      padding:6px 10px;
      border:1px solid var(--b);
      background:#fff;
      border-radius:6px;
      cursor:pointer;
      text-decoration:none;
      color:inherit;
      display:inline-flex;
      align-items:center;
      font-size:14px;
      line-height:1;
      vertical-align: middle;
    }
    button:hover, .btn:hover { background:#f9fafb; }
    button.small, .btn.small { padding:2px 8px; font-size:12px; }
    button.danger { border-color:#fca5a5; }

    table { border-collapse:collapse; width:100%; font-size:14px; }
    th, td { border:1px solid #ccc; padding:6px 8px; text-align:left; }
    th { background:#f3f4f6; }
    td.num { text-align:center; width:90px; }
    td.lp { width:50px; text-align:center; }

    .msg { padding:8px 10px; border-radius:8px; margin-bottom:10px; }
    .msg.info { background:#ecfeff; border:1px solid #a5f3fc; }
    .msg.err  { background:#fff1f2; border:1px solid #fecdd3; }
    .muted { color:var(--mut); font-size:12px; }

    .hidden { display:none !important; }

    td.akcje { display:flex; flex-wrap:wrap; gap:6px; align-items:center; }
    td.akcje form { margin:0; }

    @media (max-width:700px){
      .bar { gap:6px; }
      td.akcje { gap:4px; }
    }
    .footer {
      margin-top: 30px;
      text-align: left;
      color: #6b7280;
      font-size: 13px;
    }
    .footer a {
      color: #6b7280;
      text-decoration: none;
    }

    /* --- Kropka statusu po prawej stronie nazwiska --- */
    .name-with-dot{
      display:inline-flex;
      align-items:center;
      gap:6px;
      white-space:nowrap;
    }
    .status-dot{
      display:inline-block;
      width:8px;
      height:8px;
      border-radius:50%;
      background:#ef4444;
    }
  </style>
</head>
<body>

<!-- NAGŁÓWEK -->
<section class="hero">
  <h1 class="panel-title">Panel działu</h1>
  <p>{{ group }}</p>
</section>

{% if info %}<div class="msg info">{{ info }}</div>{% endif %}
{% if error %}<div class="msg err">{{ error }}</div>{% endif %}

<!-- KARTA: Szybkie akcje -->
<div class="card">
  <h2>Szybkie akcje</h2>

  <!-- GÓRNY rząd: wybór miesiąca/roku + przyciski -->
  <div class="bar" style="margin-top:4px;">
    <form method="post">
      {% csrf_token %}
      <label>
        <select name="month">
          {% for m in months %}
            <option value="{{ m }}"{% if m == from_month %} selected{% endif %}>{{ m }}</option>
          {% endfor %}
        </select>
      </label>
      <label>
        <select name="year">
          {% for y in years %}
            <option value="{{ y }}"{% if y == from_year %} selected{% endif %}>{{ y }}</option>
          {% endfor %}
        </select>
      </label>

      <button type="submit" name="action" value="go_to_edit">Przejdź do edycji</button>
      <button type="submit" formmethod="get" formaction="{% url 'grafik' group %}">Ustaw grafik</button>
    </form>

    <button type="button" onclick="toggleForm('credForm', true, 'input')">Zmień logowanie</button>
    <form id="credForm" class="hidden togglable" method="post">
      {% csrf_token %}
      <input type="hidden" name="action" value="change_credentials">
      <input type="text" name="login" placeholder="Nowy login">
      <input type="text" name="password" placeholder="Nowe hasło">
      <button>Zapisz</button>
    </form>

    <form method="post" action="{% url 'logout' group %}">
      {% csrf_token %}
      <button type="submit">Wyloguj</button>
    </form>
  </div>

  <!-- DOLNY rząd: wszystko od LEWEJ (dodaj + eksport + import) -->
  <div class="bar" style="margin-top:10px; justify-content:flex-start;">

    <!-- Dodaj pracownika -->
    <form method="post" style="display:flex; gap:8px; align-items:center;">
      {% csrf_token %}
      <input type="hidden" name="action" value="add_employee">
      <input type="text" name="new_emp" placeholder="Nazwisko i imię" required>
      <button>Dodaj</button>
    </form>

    <!-- Eksport CSV -->
    <a class="btn" href="{% url 'export_profiles_csv' group %}">Eksport CSV</a>

    <!-- Import CSV (ukryte pole pliku + widoczny przycisk) -->
    <form id="importCsvForm" method="post" action="{% url 'import_profiles_csv' group %}" enctype="multipart/form-data">
      {% csrf_token %}
      <input id="csvFileInput" type="file" name="csv" accept=".csv" class="hidden">
      <button type="button" class="btn" onclick="triggerCsvPicker()">Import CSV</button>
    </form>

  </div>
</div>

<!-- KARTA: Filtr i zakres -->
<div class="card">
  <h2>Filtr i zakres</h2>
  <form method="get" class="bar">
    <input type="hidden" name="action" value="show_stats">
    <input type="text" name="q" value="{{ q }}" placeholder="Szukaj pracownika…">
    <label>Od:
      <select name="from_month">
        {% for m in months %}
          <option value="{{ m }}"{% if m == from_month %} selected{% endif %}>{{ m }}</option>
        {% endfor %}
      </select>
      <select name="from_year">
        {% for y in years %}
          <option value="{{ y }}"{% if y == from_year %} selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>
    </label>
    <label>Do:
      <select name="to_month">
        {% for m in months %}
          <option value="{{ m }}"{% if m == to_month %} selected{% endif %}>{{ m }}</option>
        {% endfor %}
      </select>
      <select name="to_year">
        {% for y in years %}
          <option value="{{ y }}"{% if y == to_year %} selected{% endif %}>{{ y }}</option>
        {% endfor %}
      </select>
    </label>
    <button>Pokaż Nd./L4</button>
    <a class="muted" href="?">Wyczyść filtr</a>
  </form>
</div>

<!-- KARTA: Pracownicy -->
<div class="card">
  <h2>Pracownicy</h2>
  <table>
    <thead>
      <tr>
        <th class="lp">Lp</th>
        <th>Nazwisko i imię</th>
        <th>Stanowisko</th>
        <th>Kontakt</th>
        <th class="num">Dni robocze</th>
        <th class="num">Dni świąteczne</th>
        <th class="num">Chorobowe</th>
        <th style="width:560px;">Akcja</th>
      </tr>
    </thead>
    <tbody>
      {% for row in table_rows %}
      <tr>
        <td class="lp">{{ forloop.counter }}</td>
        <td>
          <span class="name-with-dot">
            <a href="{% url 'employee_profile' group row.name %}">{{ row.name }}</a>
            {% if row.exam_soon %}
              <span class="status-dot" title="Do wygaśnięcia badań lekarskich pozostało {{ row.exam_days_left }} dni"></span>
            {% endif %}
          </span>
        </td>
        <td>{{ row.position }}</td>
        <td>{{ row.contact|default:"—" }}</td>
        <td class="num">{{ row.workdays }}</td>
        <td class="num">{{ row.ndz }}</td>
        <td class="num">{{ row.l4 }}</td>
        <td class="akcje">
          <form method="post">{% csrf_token %}
            <input type="hidden" name="action" value="move_up">
            <input type="hidden" name="emp" value="{{ row.name }}">
            <button class="small" title="Do góry">↑</button>
          </form>
          <form method="post">{% csrf_token %}
            <input type="hidden" name="action" value="move_down">
            <input type="hidden" name="emp" value="{{ row.name }}">
            <button class="small" title="W dół">↓</button>
          </form>
          <button type="button" class="small" onclick="toggleForm('editForm{{ forloop.counter }}', true, 'input')">Edytuj</button>
          <form id="editForm{{ forloop.counter }}" class="hidden togglable" method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="edit_employee">
            <input type="hidden" name="old_emp" value="{{ row.name }}">
            <input type="text" name="new_emp" value="{{ row.name }}" placeholder="Nazwisko i imię" style="width:180px;">
            <input type="text" name="new_pos" value="{{ row.position }}" placeholder="Stanowisko" style="width:160px;">
            <input type="text" name="new_contact" value="{{ row.contact }}" placeholder="Kontakt" style="width:160px;">
            <button class="small">Zapisz</button>
          </form>
          <form method="post" onsubmit="return confirm('Usunąć {{ row.name }}?');">
            {% csrf_token %}
            <input type="hidden" name="action" value="remove_employee">
            <input type="hidden" name="emp" value="{{ row.name }}">
            <button class="small danger">Usuń</button>
          </form>
          <button type="button" class="small" onclick="toggleForm('transferForm{{ forloop.counter }}', true, 'select')">Przenieś</button>
          <form id="transferForm{{ forloop.counter }}" class="hidden togglable" method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="transfer_employee">
            <input type="hidden" name="emp" value="{{ row.name }}">
            <select name="target_group" required>
              <option value="" disabled selected>Wybierz dział</option>
              {% for g in groups_all %}
                {% if g != group %}
                  <option value="{{ g }}">{{ g }}</option>
                {% endif %}
              {% endfor %}
            </select>
            <button class="small">OK</button>
          </form>
        </td>
      </tr>
      {% empty %}
      <tr><td colspan="8" class="muted">Brak pracowników.</td></tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<script>
function toggleForm(id, closeOthers, focusKind) {
  var el = document.getElementById(id);
  if (!el) return;
  if (closeOthers) {
    document.querySelectorAll('.togglable').forEach(function(f) {
      if (f.id !== id) f.classList.add('hidden');
    });
  }
  el.classList.toggle('hidden');
  if (!el.classList.contains('hidden')) {
    if (focusKind === 'input') {
      var inp = el.querySelector('input[type="text"], input:not([type])');
      if (inp) { inp.focus(); inp.select && inp.select(); }
    } else if (focusKind === 'select') {
      var sel = el.querySelector('select');
      if (sel) sel.focus();
    }
  }
}

/* Import CSV – ukryty input + auto-submit po wyborze */
function triggerCsvPicker() {
  var inp = document.getElementById('csvFileInput');
  if (!inp) return;
  inp.click();
}
document.addEventListener('DOMContentLoaded', function() {
  var inp = document.getElementById('csvFileInput');
  if (inp) {
    inp.addEventListener('change', function() {
      if (inp.files && inp.files.length > 0) {
        document.getElementById('importCsvForm').submit();
      }
    });
  }
});
</script>

<footer class="footer">
  Hubert Dziczek – <a href="mailto:optymalizacje.procesow@gmail.com">optymalizacje.procesow@gmail.com</a>
</footer>

</body>
</html>
